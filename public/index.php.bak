<?php
session_start();
require_once __DIR__ . '/../config/database.php';
require_once __DIR__ . '/../config/session.php';
require_once __DIR__ . '/../modules/users/Auth.php';
require_once __DIR__ . '/../modules/events/EventService.php';
require_once __DIR__ . '/../modules/registrations/RegistrationService.php';
require_once __DIR__ . '/../analytics/AnalyticsService.php';

$auth = new Auth();
$eventService = new EventService();
$registrationService = new RegistrationService();
$analyticsService = new AnalyticsService();

// Redirect if admin
if ($auth->isAdmin()) {
    header('Location: admin/dashboard.php');
    exit;
}

$currentUser = $auth->getCurrentUser();
$keyword = $_GET['q'] ?? '';
$category = $_GET['kategori'] ?? '';

if (!empty($keyword) || !empty($category)) {
    $events = $eventService->searchEvents($keyword, $category);
} else {
    $events = $eventService->getAllEvents();
}

// Get Stats
$stats = $analyticsService->getEventStats();
?>
<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventKu - Jelajahi Event Kampus</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/landing.css">
</head>

<body>
    <?php include 'includes/sidebar.php'; ?>

    <div class="main-content">
        <!-- Hero Section -->
        <div class="hero-wrapper">
            <div class="hero-bg-animated"></div>
            <div class="hero-content">
                <span
                    class="badge bg-white text-primary rounded-pill px-3 py-2 mb-3 fw-bold bg-opacity-90 backdrop-blur">
                    ‚ú® Platform Event Mahasiswa Terlengkap
                </span>
                <h1 class="hero-title">Temukan Pengalaman Baru, <br>Raih Prestasi Gemilang</h1>
                <p class="hero-subtitle">
                    Bergabunglah dengan ribuan mahasiswa lainnya. Temukan seminar, workshop, dan kompetisi yang akan
                    mengembangkan potensimu.
                </p>

                <form action="" method="GET" class="hero-search-container">
                    <input type="text" name="q" class="hero-search-input"
                        placeholder="Cari event (contoh: Seminar AI)..." value="<?= htmlspecialchars($keyword) ?>">
                    <?php if (!empty($category)): ?>
                        <input type="hidden" name="kategori" value="<?= htmlspecialchars($category) ?>">
                    <?php endif; ?>
                    <button type="submit" class="hero-search-btn">
                        <i class="bi bi-search me-2"></i>Cari
                    </button>
                </form>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value"><?= $stats['total_events'] ?? 0 ?>+</span>
                    <span class="stat-label">Event Tersedia</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value"><?= $stats['upcoming_events'] ?? 0 ?></span>
                    <span class="stat-label">Event Mendatang</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value"><?= $stats['total_registrations'] ?? 0 ?>+</span>
                    <span class="stat-label">Peserta Bergabung</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value"><?= $stats['total_users'] ?? 0 ?></span>
                    <span class="stat-label">Mahasiswa Aktif</span>
                </div>
            </div>
        </div>

        <!-- Categories & Filter -->
        <div class="category-section">
            <div class="section-title">
                <span>
                    <?php if (!empty($keyword)): ?>
                        Hasil pencarian: "<?= htmlspecialchars($keyword) ?>"
                    <?php else: ?>
                        Kategori Populer üî•
                    <?php endif; ?>
                </span>
                <?php if (!empty($category) || !empty($keyword)): ?>
                    <a href="index.php" class="btn btn-outline-secondary rounded-pill btn-sm">
                        <i class="bi bi-x-circle me-1"></i>Reset Filter
                    </a>
                <?php endif; ?>
            </div>

            <div class="category-pills">
                <a href="index.php" class="category-pill <?= empty($category) ? 'active' : '' ?>">
                    <i class="bi bi-grid"></i> Semua
                </a>
                <a href="index.php?kategori=Akademik"
                    class="category-pill <?= $category === 'Akademik' ? 'active' : '' ?>">
                    <i class="bi bi-mortarboard"></i> Akademik
                </a>
                <a href="index.php?kategori=Non-Akademik"
                    class="category-pill <?= $category === 'Non-Akademik' ? 'active' : '' ?>">
                    <i class="bi bi-palette"></i> Non-Akademik
                </a>
                <a href="index.php?kategori=Seminar"
                    class="category-pill <?= $category === 'Seminar' ? 'active' : '' ?>">
                    <i class="bi bi-people"></i> Seminar
                </a>
                <a href="index.php?kategori=Workshop"
                    class="category-pill <?= $category === 'Workshop' ? 'active' : '' ?>">
                    <i class="bi bi-tools"></i> Workshop
                </a>
                <a href="index.php?kategori=Lomba" class="category-pill <?= $category === 'Lomba' ? 'active' : '' ?>">
                    <i class="bi bi-trophy"></i> Lomba
                </a>
            </div>
        </div>

        <!-- Events Grid -->
        <div class="events-section">
            <?php if (empty($events)): ?>
                <div class="text-center py-5">
                    <img src="https://img.freepik.com/free-vector/no-data-concept-illustration_114360-536.jpg"
                        alt="No Events" style="max-width: 300px; opacity: 0.8;">
                    <h5 class="text-muted mt-4 fw-normal">Belum ada event yang sesuai kriteria Anda.</h5>
                    <a href="index.php" class="btn btn-primary mt-3 rounded-pill px-4">Lihat Semua Event</a>
                </div>
            <?php else: ?>
                <div class="event-grid">
                    <?php
                    $patterns = ['pattern-academic', 'pattern-non-academic', 'pattern-seminar'];
                    $i = 0;
                    foreach ($events as $event):
                        $isRegistered = $auth->isLoggedIn() ? $registrationService->isRegistered($currentUser['id'], $event['id']) : false;
                        $availableQuota = $event['kuota'] - ($event['registered_count'] ?? 0);
                        // Determine pattern based on category
                        $patternClass = 'pattern-seminar'; // default
                        if ($event['kategori'] == 'Akademik')
                            $patternClass = 'pattern-academic';
                        if ($event['kategori'] == 'Non-Akademik')
                            $patternClass = 'pattern-non-academic';
                        ?>
                        <div class="modern-card">
                            <div class="card-image-wrapper <?= $patternClass ?>">
                                <div class="card-badges">
                                    <span class="badge-custom badge-category">
                                        <?= htmlspecialchars($event['kategori']) ?>
                                    </span>
                                    <?php if (!empty($event['price']) && $event['price'] > 0): ?>
                                        <span class="badge-custom badge-price">
                                            Rp <?= number_format($event['price'], 0, ',', '.') ?>
                                        </span>
                                    <?php else: ?>
                                        <span class="badge-custom badge-price free">Gratis</span>
                                    <?php endif; ?>
                                </div>
                            </div>

                            <div class="card-content">
                                <div class="event-date-modern">
                                    <i class="bi bi-calendar4-week"></i>
                                    <?= date('d M Y, H:i', strtotime($event['tanggal'])) ?>
                                </div>
                                <h3 class="event-title-modern">
                                    <?= htmlspecialchars($event['title']) ?>
                                </h3>
                                <div class="event-location-modern">
                                    <i class="bi bi-geo-alt"></i>
                                    <?= htmlspecialchars($event['lokasi']) ?>
                                </div>
                                <p class="event-description-modern">
                                    <?= htmlspecialchars(strip_tags($event['deskripsi'])) ?>
                                </p>

                                <div class="card-footer-modern">
                                    <div class="participants-info">
                                        <span class="participants-count">
                                            <i class="bi bi-people-fill me-1 text-primary"></i>
                                            <?= $event['registered_count'] ?? 0 ?> / <?= $event['kuota'] ?>
                                        </span>
                                    </div>

                                    <?php if ($auth->isLoggedIn() && !$isRegistered && $availableQuota > 0): ?>
                                        <a href="event-detail.php?id=<?= $event['id'] ?>" class="btn-card-action btn-card-primary">
                                            Lihat Detail <i class="bi bi-arrow-right ms-1"></i>
                                        </a>
                                    <?php elseif ($isRegistered): ?>
                                        <a href="event-detail.php?id=<?= $event['id'] ?>"
                                            class="btn-card-action btn-card-outline text-success border-success">
                                            <i class="bi bi-check-circle me-1"></i> Terdaftar
                                        </a>
                                    <?php elseif ($availableQuota <= 0): ?>
                                        <button disabled class="btn-card-action btn-secondary opacity-75">
                                            Penuh
                                        </button>
                                    <?php else: ?>
                                        <a href="event-detail.php?id=<?= $event['id'] ?>" class="btn-card-action btn-card-outline">
                                            Lihat Detail
                                        </a>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            <?php endif; ?>
        </div>

        <!-- Footer -->
        <footer class="modern-footer">
            <div class="container">
                <div class="row gy-4">
                    <div class="col-lg-4">
                        <a href="index.php" class="footer-brand">EventKu</a>
                        <p class="text-muted small">
                            Platform manajemen event mahasiswa terdepan. Temukan, ikuti, dan kembangkan potensimu
                            melalui berbagai kegiatan positif.
                        </p>
                    </div>
                    <div class="col-lg-2 col-6">
                        <h6 class="fw-bold mb-3">Event</h6>
                        <ul class="footer-links">
                            <li><a href="index.php?kategori=Akademik">Akademik</a></li>
                            <li><a href="index.php?kategori=Seminar">Seminar</a></li>
                            <li><a href="index.php?kategori=Lomba">Kompetisi</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-2 col-6">
                        <h6 class="fw-bold mb-3">Akun</h6>
                        <ul class="footer-links">
                            <?php if ($auth->isLoggedIn()): ?>
                                <li><a href="profile.php">Profile</a></li>
                                <li><a href="my-events.php">Event Saya</a></li>
                                <li><a href="auth/logout.php">Logout</a></li>
                            <?php else: ?>
                                <li><a href="login.php">Login</a></li>
                                <li><a href="register.php">Daftar</a></li>
                            <?php endif; ?>
                        </ul>
                    </div>
                    <div class="col-lg-4">
                        <h6 class="fw-bold mb-3">Hubungi Kami</h6>
                        <p class="text-muted small mb-2"><i class="bi bi-envelope me-2"></i> info@eventku.campus.ac.id
                        </p>
                        <p class="text-muted small"><i class="bi bi-telephone me-2"></i> +62 812 3456 7890</p>
                        <div class="d-flex gap-3 mt-3">
                            <a href="#" class="text-secondary"><i class="bi bi-instagram fs-5"></i></a>
                            <a href="#" class="text-secondary"><i class="bi bi-twitter-x fs-5"></i></a>
                            <a href="#" class="text-secondary"><i class="bi bi-facebook fs-5"></i></a>
                        </div>
                    </div>
                </div>
                <div class="border-top mt-5 pt-4 text-center text-muted small">
                    &copy; <?= date('Y') ?> EventKu. All rights reserved. Made with ‚ù§Ô∏è for Students.
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>